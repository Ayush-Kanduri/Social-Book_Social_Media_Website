class ChatEngine{constructor(e,t,s){this.chatBoxId=$(` #${e}`),this.userEmail=t,this.userName=s,this.socket=io.connect("http://localhost:5000"),this.userEmail&&this.connectionHandler()}connectionHandler(){let e=this;this.socket.on("connect",(function(){e.onlineStatusUpdate(e),e.configureChatBox(e),e.userJoined(e),e.userLeft(e)})),e.receiveMessage(e),e.socket.on("new_message_notify",(function(e){const t=document.getElementsByClassName("chat-friend");for(let s of t)s.dataset.email===e.user_email&&(s.querySelector("#new-messages").style.color="black")}))}sendMessage(e,t){$(" #send-message-button").click((s=>{let a=$(" #message-input").val(),n={day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"};""!==a&&e.socket.emit("send_message",{message:a,user_email:e.userEmail,user_name:e.userName,timestamp:(new Date).toLocaleString("default",n),chat_room:t.chat_room,friend_email:t.friend_email}),$(" #message-input").val("")}))}receiveMessage(e){e.socket.on("receive_message",(function(t){$.ajax({type:"POST",url:"/messages/create",data:{message:t.message,user_email:t.user_email,user_name:t.user_name,timestamp:t.timestamp,chat_room:t.chat_room,friend_email:t.friend_email},success:function(t){t=t.data,e.chatMessage(t),e.socket.emit("new_message",t)},error:function(e){console.log("Error: ",e)}})}))}chatMessage(e){let t=document.getElementById("chat-ul"),s=document.createElement("li"),a=document.createElement("p"),n=document.createElement("span"),o=document.createElement("span"),l=document.createElement("span"),i=e.alignment;a.classList.add("chat-message",i),s.classList.add("chat-li",i),n.classList.add("chat-message-name"),o.classList.add("chat-message-time"),l.classList.add("chat-message-text"),n.textContent=e.user_name,o.textContent=e.timestamp,l.textContent=e.message,a.appendChild(n),a.appendChild(o),a.appendChild(l),s.appendChild(a),t.appendChild(s),t.scrollTop=t.scrollHeight}chatRoomAJAX(e,t,s){let a="";return $.ajax({type:"POST",url:"/messages/join",async:!1,data:{sender_email:e,receiver_email:t},success:function(e){if(a=e.data.chatRoom,e.data.chats.length>0)for(let t of e.data.chats){let e={message:t.content,user_name:t.sender.name,timestamp:t.time,alignment:t.sender.email===s.userEmail?"receiver":"sender"};s.chatMessage(e)}},error:function(e){console.log("Error: ",e)}}),a}onlineStatusUpdate(e){e.socket.emit("online_status",{user_email:e.userEmail}),e.socket.on("user_online",(function(t){let s=Object.entries(t);s=s.filter((t=>t[0]!=e.socket.id));let a=Object.fromEntries(s);e.onlineStatusToggle(a)})),e.socket.on("user_offline",(function(t){let s=Object.entries(t);s=s.filter((t=>t[0]!=e.socket.id));let a=Object.fromEntries(s);e.onlineStatusToggle(a)}))}userJoined(e){e.socket.on("user_joined",(function(t){e.sendMessage(e,t)}))}userLeft(e){e.socket.on("user_left",(function(e){}))}configureChatBox(e){let t=document.getElementById("chatbox"),s=document.getElementsByClassName("chat-friend"),a=document.getElementsByClassName("chat-friends-list")[0],n=document.getElementsByClassName("chat-screen")[0],o=document.getElementsByClassName("chat-input")[0],l=document.getElementById("toggle-back"),i=document.getElementById("toggle-down"),c="",r="",m="";document.getElementById("other-chat-user").textContent="",i.addEventListener("click",(()=>{t.classList.toggle("ht-350"),i.classList.contains("fa-angle-down")?(i.classList.remove("fa-angle-down"),i.classList.add("fa-angle-up")):(i.classList.remove("fa-angle-up"),i.classList.add("fa-angle-down"))}));if("0"!==document.getElementById("hidden-friend-length").value){for(let t of s)t.addEventListener("click",(()=>{a.classList.toggle("show"),n.classList.toggle("hide"),o.classList.toggle("hide"),l.classList.toggle("hide"),c=t.getAttribute("data-name"),r=t.getAttribute("data-email"),document.getElementById("other-chat-user").textContent=c,document.querySelectorAll("#chat-ul > li").forEach((e=>{e.remove()})),l.onclick=()=>{t.querySelector("#new-messages").style.color="rgb(111, 0, 0)"},m=e.chatRoomAJAX(e.userEmail,r,e),e.joinRoom(e,m,r)}));l.addEventListener("click",(()=>{a.classList.toggle("show"),n.classList.toggle("hide"),o.classList.toggle("hide"),l.classList.toggle("hide"),document.getElementById("other-chat-user").textContent="",e.leaveRoom(e,m)}))}}onlineStatusToggle(e){if("0"===document.getElementById("hidden-friend-length").value)return;let t=document.getElementsByClassName("chat-friend");if(e&&0===Object.keys(e).length&&e.constructor===Object)for(let e of t)e.children[2].children[0].children[0].style.color="rgb(111, 0, 0)";else for(const[s,a]of Object.entries(e))for(let e of t)e.children[2].children[0].children[0].style.color="rgb(111, 0, 0)",e.getAttribute("data-email")===a&&(e.children[2].children[0].children[0].style.color="green")}joinRoom(e,t,s){e.socket.emit("join_room",{user_email:e.userEmail,user_name:e.userName,friend_email:s,chat_room:t})}leaveRoom(e,t){e.socket.emit("leave_room",{user_email:e.userEmail,user_name:e.userName,chat_room:t})}}